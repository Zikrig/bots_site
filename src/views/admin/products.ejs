<div class="p-6 sm:p-8">
    <div class="flex flex-col sm:flex-row sm:items-center sm:justify-between gap-4 mb-8">
        <h1 class="text-2xl font-semibold text-slate-900">Товары</h1>
        <button type="button" onclick="openProductModal()" class="rounded-xl bg-brand-500 hover:bg-brand-600 text-white font-medium px-4 py-2.5 transition">
            Добавить товар
        </button>
    </div>

    <div id="products-list" class="space-y-4">
        <p class="text-slate-500">Загрузка…</p>
    </div>
</div>

<!-- Modal: create/edit product -->
<div id="product-modal" class="hidden fixed inset-0 z-50 overflow-y-auto">
    <div class="flex min-h-full items-center justify-center p-4">
        <div class="fixed inset-0 bg-slate-900/60" onclick="closeProductModal()"></div>
        <div class="relative bg-white rounded-2xl shadow-xl max-w-lg w-full p-6 sm:p-8 max-h-[90vh] overflow-y-auto">
            <h2 id="product-modal-title" class="text-xl font-semibold text-slate-900 mb-6">Новый товар</h2>
            <form id="product-form" class="space-y-4">
                <input type="hidden" id="product-id" name="id">
                <div>
                    <label for="product-title" class="block text-sm font-medium text-slate-700 mb-1">Название *</label>
                    <input type="text" id="product-title" name="title" required maxlength="255" class="w-full rounded-xl border border-slate-300 px-4 py-2.5 focus:ring-2 focus:ring-brand-500 outline-none">
                </div>
                <div>
                    <label for="product-slug" class="block text-sm font-medium text-slate-700 mb-1">Slug (опционально)</label>
                    <input type="text" id="product-slug" name="slug" maxlength="255" class="w-full rounded-xl border border-slate-300 px-4 py-2.5 focus:ring-2 focus:ring-brand-500 outline-none">
                </div>
                <div>
                    <label for="product-short" class="block text-sm font-medium text-slate-700 mb-1">Краткое описание</label>
                    <input type="text" id="product-short" name="short_description" maxlength="500" class="w-full rounded-xl border border-slate-300 px-4 py-2.5 focus:ring-2 focus:ring-brand-500 outline-none">
                </div>
                <div>
                    <label for="product-description" class="block text-sm font-medium text-slate-700 mb-1">Описание</label>
                    <textarea id="product-description" name="description" rows="4" class="w-full rounded-xl border border-slate-300 px-4 py-2.5 focus:ring-2 focus:ring-brand-500 outline-none resize-none"></textarea>
                </div>
                <div>
                    <label for="product-image" class="block text-sm font-medium text-slate-700 mb-1">URL изображения</label>
                    <input type="url" id="product-image" name="image_url" maxlength="512" class="w-full rounded-xl border border-slate-300 px-4 py-2.5 focus:ring-2 focus:ring-brand-500 outline-none">
                </div>
                <div class="flex items-center gap-2">
                    <input type="checkbox" id="product-visible" name="is_visible" checked class="rounded border-slate-300 text-brand-600 focus:ring-brand-500">
                    <label for="product-visible" class="text-sm text-slate-700">Показывать на сайте</label>
                </div>
                <div class="flex gap-3 pt-2">
                    <button type="submit" id="product-submit" class="rounded-xl bg-brand-500 hover:bg-brand-600 text-white font-medium px-4 py-2.5 transition">Сохранить</button>
                    <button type="button" onclick="closeProductModal()" class="rounded-xl bg-slate-100 hover:bg-slate-200 text-slate-700 font-medium px-4 py-2.5 transition">Отмена</button>
                </div>
            </form>
        </div>
    </div>
</div>
<script>
var API = '/api/v1';

function loadProducts() {
    fetch(API + '/admin/products', { credentials: 'include' })
        .then(function(r) {
            if (r.status === 401) { window.location.href = '/admin/login'; return []; }
            return r.json();
        })
        .then(function(list) {
            var el = document.getElementById('products-list');
            if (!list || list.length === 0) {
                el.innerHTML = '<p class="text-slate-500">Нет товаров. Добавьте первый.</p>';
                return;
            }
            el.innerHTML = list.map(function(p) {
                return '<div class="flex items-center gap-4 rounded-xl border border-slate-200 bg-white p-4 shadow-sm" data-id="' + p.id + '">' +
                    '<div class="w-16 h-16 rounded-lg bg-slate-100 flex-shrink-0 overflow-hidden">' +
                    (p.image_url ? '<img src="' + escapeHtml(p.image_url) + '" alt="" class="w-full h-full object-cover">' : '') +
                    '</div>' +
                    '<div class="flex-1 min-w-0">' +
                    '<p class="font-medium text-slate-900">' + escapeHtml(p.title) + '</p>' +
                    '<p class="text-sm text-slate-500 truncate">' + escapeHtml(p.short_description || '') + '</p>' +
                    '</div>' +
                    '<span class="text-sm ' + (p.is_visible ? 'text-green-600' : 'text-slate-400') + '">' + (p.is_visible ? 'Видим' : 'Скрыт') + '</span>' +
                    '<button type="button" onclick="editProduct(' + p.id + ')" class="rounded-lg px-3 py-1.5 text-sm bg-slate-100 hover:bg-slate-200 text-slate-700">Изменить</button>' +
                    '<button type="button" onclick="deleteProduct(' + p.id + ', \'' + escapeHtml(p.title).replace(/'/g, "\\'") + '\')" class="rounded-lg px-3 py-1.5 text-sm bg-red-50 hover:bg-red-100 text-red-600">Удалить</button>' +
                    '</div>';
            }).join('');
        })
        .catch(function() {
            document.getElementById('products-list').innerHTML = '<p class="text-red-600">Ошибка загрузки.</p>';
        });
}

function escapeHtml(s) {
    if (!s) return '';
    var div = document.createElement('div');
    div.textContent = s;
    return div.innerHTML;
}

function openProductModal(product) {
    document.getElementById('product-modal-title').textContent = product ? 'Редактировать товар' : 'Новый товар';
    document.getElementById('product-id').value = product ? product.id : '';
    document.getElementById('product-title').value = product ? product.title : '';
    document.getElementById('product-slug').value = product ? (product.slug || '') : '';
    document.getElementById('product-short').value = product ? (product.short_description || '') : '';
    document.getElementById('product-description').value = product ? (product.description || '') : '';
    document.getElementById('product-image').value = product ? (product.image_url || '') : '';
    document.getElementById('product-visible').checked = product ? product.is_visible : true;
    document.getElementById('product-modal').classList.remove('hidden');
}

function closeProductModal() {
    document.getElementById('product-modal').classList.add('hidden');
}

function editProduct(id) {
    fetch(API + '/admin/products/' + id, { credentials: 'include' })
        .then(function(r) { return r.json(); })
        .then(function(p) {
            openProductModal(p);
        });
}

function deleteProduct(id, title) {
    if (!confirm('Удалить товар «' + title + '»?')) return;
    fetch(API + '/admin/products/' + id, { method: 'DELETE', credentials: 'include' })
        .then(function(r) {
            if (r.status === 204) loadProducts();
        });
}

document.getElementById('product-form').addEventListener('submit', function(e) {
    e.preventDefault();
    var id = document.getElementById('product-id').value;
    var payload = {
        title: document.getElementById('product-title').value.trim(),
        slug: document.getElementById('product-slug').value.trim() || null,
        short_description: document.getElementById('product-short').value.trim() || '',
        description: document.getElementById('product-description').value.trim() || '',
        image_url: document.getElementById('product-image').value.trim() || '',
        is_visible: document.getElementById('product-visible').checked
    };
    var url = API + '/admin/products' + (id ? '/' + id : '');
    var method = id ? 'PATCH' : 'POST';
    fetch(url, {
        method: method,
        headers: { 'Content-Type': 'application/json' },
        credentials: 'include',
        body: JSON.stringify(payload)
    }).then(function(r) {
        if (r.ok) { closeProductModal(); loadProducts(); }
        else r.json().then(function(d) { alert(d.detail || 'Ошибка'); });
    });
});

loadProducts();
</script>
